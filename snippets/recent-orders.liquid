<section class="recent-orders">
  <div>
    <h2>Your PREVIOUS Orders</h2>
    <account-recent-orders>
      <table class="orders-table">
        <thead>
          <tr>
            <td>Address ID</td>
            <td>Order ID</td>
            <td>Total Price</td>
            <td>Tiered Discount Value</td> <!-- New column -->
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="orders-loader">
        <div class="orders-loader__spinner"><span class="visually-hidden">Loading...</span></div>
      </div>
    </account-recent-orders>
  </div>
</section>

<script>
  class AccountRecentOrders extends HTMLElement {
    selectors = {
      loader: '.orders-loader',
      table: '.orders-table',
    };

    constructor() {
      super();
      this.loadRecentOrders();
    }

    async login() {
      this.session = await recharge.auth.loginShopifyAppProxy();
    }

    async loadRecentOrders() {
      this.setLoading(true);
      await this.login();

      try {
        const response = await recharge.charge.listCharges(this.session, {
          limit: 5, // Adjust to show more recent orders if needed
          status: 'success', // Fetch only completed (previous) orders
          include: ["customer", "charge_activities", "metafields", "payment_methods"]
        });

        const orders = response.charges;

        if (orders && orders.length > 0) {
          this.populateOrders(orders);
        } else {
          console.log('No orders found');
        }
      } catch (error) {
        console.error('Error fetching recent orders:', error);
      }

      this.setLoading(false);
    }

    populateOrders(orders) {
      const tableBody = this.querySelector(`${this.selectors.table} tbody`);
      if (!tableBody) {
        console.error('Table body not found');
        return;
      }

      orders.forEach(order => {
        tableBody.append(this.createRow(order));
      });
    }

    createRow(order) {
      const tieredDiscountValue = this.cal_tiered_discount_value(order); // Calculate tiered discount

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${order.address_id}</td>
        <td>${order.id}</td>
        <td>${order.total_price}</td>
        <td>${tieredDiscountValue}</td> <!-- Add tiered discount value -->
      `;
      console.log('Appending row RECENT:', tr); // Log the row being appended
      return tr;
    }
    cal_tiered_discount_value(order) {
  // Parse values or default to 0 if undefined
  const totalLineItemPrice = parseFloat(
    order.line_items?.reduce((total, item) => {
      const unitPrice = parseFloat(item.unit_price) || 0; // Ensure unit_price is a number
      const quantity = parseInt(item.quantity) || 0; // Ensure quantity is an integer
      return total + unitPrice * quantity;
    }, 0)
  ) || 0;

  const totalPrice = parseFloat(order.total_price) || 0;
  const totalTax = parseFloat(order.total_tax) || 0;
  const totalDiscounts = parseFloat(order.total_discounts) || 0;
  const shippingPrice =
    order.shipping_lines?.reduce((total, line) => {
      const linePrice = parseFloat(line.price) || 0; // Ensure line.price is a number
      return total + linePrice;
    }, 0) || 0;

  // Calculate tiered discount value
  const tieredDiscountValue =
    totalLineItemPrice - totalPrice + totalTax + shippingPrice - totalDiscounts;

  // Debugging logs to validate each component
  console.log('Total Line Item Price:', totalLineItemPrice);
  console.log('Total Price:', totalPrice);
  console.log('Total Tax:', totalTax);
  console.log('Total Discounts:', totalDiscounts);
  console.log('Shipping Price:', shippingPrice);
  console.log('Tiered Discount Value:', tieredDiscountValue);

  // Ensure no negative values and return a fixed two-decimal string
  return Math.max(tieredDiscountValue, 0).toFixed(2);
}

    setLoading(isLoading) {
      const loader = this.querySelector(this.selectors.loader);
      loader.style.display = isLoading ? 'block' : 'none';
    }
  }

  // Define the custom element for recent orders
  if (!customElements.get('account-recent-orders')) {
    customElements.define('account-recent-orders', AccountRecentOrders);
  }
</script>
